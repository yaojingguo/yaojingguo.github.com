---
layout: post
title: "Kafka"
description: ""
category:
tags: []
---
{% include JB/setup %}


Kafka is defacto choice for message queues. But I feel that Kafka clients and its documentation are not friendly to first-time users. Here are two points I feel.

1. The documentation exposes internal details in an unclear way.
2. Kafka clients ignore a errors in a counterintuitive way.
3. The interactions between configuration options are not documented.

And here are the mails related to the above two points:

- [If timeout is short, the first poll does not return records](http://mail-archives.apache.org/mod_mbox/kafka-users/201807.mbox/%3CCANPB7a5uGMg17WnoE7dOp8QGUdjC6d9fxqe%2Bii0ScaLyfyN2EQ%40mail.gmail.com%3E)
- [The relation between min.insync.replicas and offsets.topic.replication.factor](http://mail-archives.apache.org/mod_mbox/kafka-users/201807.mbox/%3CCANPB7a4BKFuuxjDomwZJHX%2BuBcFQnnX3r_AwPdyArLDbhqsiYg%40mail.gmail.com%3E)
- [What is meaning of buffer in KafkaConsumer's Javadoc?](http://mail-archives.apache.org/mod_mbox/kafka-users/201807.mbox/%3CCANPB7a6cL5-yoEWFGhXeny8v13LMgYjEcfnh-nLqeCR7C856Cg%40mail.gmail.com%3E)
- [The asynchronous sending of a message returns no error if the Kafka server is not started](http://mail-archives.apache.org/mod_mbox/kafka-users/201807.mbox/%3CCANPB7a6-gG1dX0y4_1kxwUn0irK%2BFxS7beYGe9rXD23_E3HhxQ%40mail.gmail.com%3E)

# API Hehaviour
Synchronously send a message to a stopped bootstrap server. After `60000 ms`, the following
exception is thrown:
```
org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms.
```

Synchronously send a message to a runing bootstrap server. But the target topic does exist. The
following exception is thrown:
```
org.apache.kafka.common.errors.TimeoutException: Failed to update metadata after 60000 ms.
```

For asynchronous message sending, the following exception is thrown when the
bootstrap.servers value is unresolvable hostname such as `localhostx`.

```
org.apache.kafka.common.config.ConfigException: No resolvable bootstrap urls given in bootstrap.servers
```

For the following value for `bootstrap.servers`, no exceptions for asynchronous
message sending:
1. Unreachable hostname such `www.google.com`.
2. Unreachable IP.
3. Reachable hostname. But the Kafka server is stopped.

`poll(long timeoutMs)` will block forever if the bootstrap server is stopped.


`poll(java.time.Duration timeout)` will return after timeout. No exceptions even
the bootstrap server is down or the topic does exist on the bootstrap server.
But if a topci which has been polled is deleted, the following error will show
up:

```
2019-03-07 21:03:04,241 ERROR [main] o.a.k.c.c.i.ConsumerCoordinator: [Consumer clientId=consumer-1, groupId=test] Offset commit failed on partition test-topic-0 at offset 0: This server does not host this topic-partition.
```

# MISC
Check the committed offset for a consumer group even if there are no active members in the consumer group.
```
kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group mygroup
kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group console-consumer-88295
```

`kafka-console-producer` sends messages with a null key.


commit offset is the record for the next record to be consumed.

k-console-consumer --topic test-topic --consumer-property

offsets.retention.minutes:
```
After a consumer group loses all its consumers (i.e. becomes empty) its offsets will be kept for this retention period before getting discarded. For standalone consumers (using manual assignment), offsets will be expired after the time of last commit plus this retention period.
```


```
RecordMetadata.toString
classroom-input-0@11308
```
